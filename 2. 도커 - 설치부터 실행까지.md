# 도커 - 설치부터 실행까지

## 목차

1. 도커 설치하기
2. 도커 기본 명령어 - run, exec
3. 도커 기본 명령어 - ps, stop, rm, logs, images 등
4. 도커 컴포즈 기본
5. 도커 컴포즈 문법
6. 도커 컴포즈 명령어

------



## 1. 도커 설치하기

### Linux

```bash
curl -s <https://get.docker.com/> | sudo sh
```

위 명령어를 입력하고 패스워드를 입력하면 리눅스 배포판에 따라 최신버전의 도커를 설치해준다.

```bash
sudo usermod -aG docker ubuntu
```

ubuntu 유저를 사용하는 경우 위 명령어를 사용하여 ubuntu 유저 권한 추가한다.

### MacOS or Windows

- Docker for Mac / Docker for Window 를 설치하면 빠르고 쉽게 도커를 사용할 수 있다.
- 도커는 기본적으로 Linux를 지원하기 때문에, MacOS와 Windows에 설치되는 도커는 가상머신에 설치됨
  - MacOS: xhyve
  - Windows: Hyper-V

### 도커 설치 확인

```bash
docker version
```

- 위 명령어를 사용하면 Client와 Server가 같이 표시된다.
  - 사용하는 도커는 Client이고 localhost에 떠있는 상태이다.

### Client - Server 구조

![Client-Server_구조.png](https://github.com/jo-minjun/docker-study/blob/main/image/Client-Server_%EA%B5%AC%EC%A1%B0.png)

- docker CLI는 도커 호스트에 명령을 전달하고 결과를 받아서 출력한다.



## 2. 도커 기본 명령어 - run, exec

### run

```bash
docker run [OPTIONS] IMAGE[:TAG|@DIGEST] [COMMAND] [ARG...]
```

- 컨테이너를 실행하려면 위 명령어를 사용하면 된다.
- run 명령어는 사용할 이미지가 저장되어 있는지 확인하고, 없으면 다운로드한 컨테이너를 생성하고 시작한다.

### 주요 OPTIONS

| -d       | detached mode (백그라운드 모드)                        |
| -------- | ------------------------------------------------------ |
| -p       | 호스트와 컨테이너의 포트를 연결                        |
| -v       | 호스트와 컨테이너의 디렉토리를 연결                    |
| -e       | 컨테이너 내에서 사용할 환경변수 설정                   |
| —name    | 컨테이너 이름 설정                                     |
| —rm      | 프로세스 종료시 컨테이너 자동 제거                     |
| -it      | -i와 -t를 동시에 사용한 것으로 터미널 입력을 위한 옵션 |
| —network | 네트워크 연결                                          |

### exec

- run 명령어와 달리 실행중인 도커 컨테이너에 접속할 때 사용하면 컨테이너 안에 ssh server 등을 설치하지 않고 exec 명령어로 접속한다.

```bash
docker exec -it mysql mysql
```

> 참고: HOST=host.docker.internal을 사용하면 띄어놓은 ip로 접근이 된다.



## 3. 도커 기본 명령어 - ps, stop, rm, logs, images 등

### ps

- 실행중인 컨테이너 목록을 확인하는 명령어이다.
- 중지된 컨테이너도 확인하려면 -a 옵션을 붙이면 된다.

```bash
docker ps
```

### stop

- 실행중인 컨테이너를 중지하는 명령어이다.
- 하나 또는 여러개를 띄어쓰기로 구분하여 중지할 수 있다.

```bash
docker stop [OPTIONS] CONTAINER [CONTAINER ...]
```

### rm

- 종료된 컨테이너를 완전히 제거하는 명령어이다.

```bash
docker rm [OPTIONS] CONTAINER [CONTAINER ...]
```

### logs

- 컨테이너가 정상적으로 동작하는지 확인하기 위해 로그를 확인하는 명령어이다.
- -f: 로그를 기다리면서 계속해서 보여준다.
- -tail: 로그의 끝부분을 보여준다.

```bash
docker logs [OPTIONS] CONTAINER
```

### images

- 도커가 다운로드한 이미지 목록을 보는 명령어이다.

```bash
docker images [OPTIONS] [REPOSITORY[:TAG]]
```

### pull

- 이미지를 다운로드하는 명령어이다.

```bash
docker pull [OPTIONS] NAME[:TAG|@DIGEST]
```

### rmi

- 이미지를 삭제하는 명령어이다.
- images 명령어를 통해 확인한 이미지 목록에서 이미지 ID를 입력하면 삭제된다.
- 그러나 컨테이너가 실행중인 이미지는 삭제되지 않는다.

```bash
docker rmi [OPTIONS] IMAGE [IMAGE ...]
```

### network create

- 도커 컨테이너끼리 이름으로 통신할 수 있는 가상 네트워크를 만드는 명령어이다.

```bash
docker network create [OPTIONS] NETWORK
```

### network connect

- 생성된 컨테이너에 네트워크를 추가합니다.

```bash
docker network connect [OPTIONS] NETWORK CONTAINER
```

### volume mount (-v)

- 컨테이너는 내려갈때 데이터도 함께 사라진다.
- 컨테이너 실행시 volume mount 옵션을 사용하면 volume을 내 저장소에 mount 할 수 있다.

```bash
-v /[mydir]:/var/lib/mysql
```



## 4. 도커 컴포즈 기본

- Docker for Mac / Docker for Window 를 설치하면 기본적으로 도커 컴포즈가 같이 설치된다.
- Linux의 경우 아래의 명령어로 따로 설치해야 한다.

```bash
sudo curl -L "<https://github.com/docker/compose/releases/download/1.26.0/docker-compose-$>(uname -s)-$(uname -m)"
sudo chmod +x /usr/local/bin/docker-compose
```

### 도커 컴포즈 설치 확인

```bash
docker-compose version
```

### up

```bash
docker-compose up -d
```

- docker-compose.yml 파일을 올린다.

### down

```bash
docker-compose down
```

- 올라간 docker-compose.yml 을 내린다.



## 5. docker-compose 문법

### version

```yaml
version: '3'
```

- docker-compose.yml의 버전이다.
- 버전에 따라 지원하는 도커 엔진 버전도 다르다.

### services

```yaml
services:
	postgres:
		...
	django:
		...
```

- 실행할 컨테이너를 정의한다.

### image

```yaml
services:
	django:
		image: django-sample
```

- 컨테이너에 사용할 이미지 이름과 태그
- 태그를 생략하면 latest이다.
- 이미지가 없으면 자동으로 pull 한다.

### ports

```yaml
services:
	django:
		...
		ports:
			- "8000:8000"
```

- 컨테이너와 연결할 포트들
- {호스트 포트}:{컨테이너 포트}

### environment

```yaml
services:
	mysql:
		...
		environment:
			- MYSQL_ROOT_PASSWORD=wp:'3'
```

- 컨테이너에서 사용할 환경변수들
- {환경변수 이름}:{값}

### volume

```yaml
services:
	django:
		...
		volumes:
			- ./app:/app
```

- 마운트하려는 디렉토리들
- {호스트 디렉토리}:{컨테이너 디렉토리}

### restart

```yaml
services:
	django:
		restart: always
```

- 재시작 정책 설정
- no, always, on-failure, unless-stopped

### build

```yaml
django:
	build:
		context: .
		dockerfile: ./compose/django/Dockerfile-dev
```

- 이미지를 자체 빌드 후 사용
- image 속성 대신 사용함
- 사용할 별도의 도커 파일이 필요함



## 6. 도커 컴포즈 명령어

### up

```yaml
docker-compose up
```

- docker-compose.yml에 정의된 컨테이너를 실행
- [—force-recreate]: 컨테이너를 새로 만들기
- [—build]: 도커 이미지를 다시 빌드

### start

```yaml
docker-compose start [CONTAINER - 컨테이너를 단일 지정할 수 있음]
```

- 멈춘 컨테이너를 재개

### restart

```yaml
docker-compose restart [CONTAINER - 컨테이너를 단일 지정할 수 있음]
```

- 컨테이너를 재시작

### stop

```yaml
docker-compost stop [CONTAINER - 컨테이너를 단일 지정할 수 있음]
```

- 컨테이너를 멈춤

### down

```yaml
docker-compose down
```

- 컨테이너를 종료하고 삭제

### logs

```yaml
docker-compose logs [-f]
```

- 컨테이너의 로그를 확인

### ps

```yaml
docker-compose ps
```

- 컨테이너의 목록

### exec

```yaml
docker-compose exec {컨테이너} {명령어}
```

- 실행중인 컨테이너에서 명령어를 실행

### build

```yaml
docker-compose build
```

- 컨테이너 build 부분에 정의된 내용대로 빌드
